{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="mb-3 text-end">
        <a href="{% url 'reservas:agregar_hotel' %}?tipo_reserva={{ tipo_reserva }}" 
        class="btn btn-success">
        <i class="bi bi-plus-lg me-2"></i>Agregar Nuevo Hotel
     </a>
    </div>
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="bi bi-building me-2"></i>Selección de Hotel y Habitaciones</h3>
            <small class="d-block mt-2">Paso 3 de 4 - Elige tu alojamiento</small>
        </div>
        
        <div class="card-body">
            <form method="post" id="paso3Form" novalidate>
                {% csrf_token %}
                
                <!-- Selector de Hotel con Search -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="form-floating">
                            <select class="form-select select2-hotel" id="hotel" name="hotel" required
                                    data-url="{% url 'reservas:hotel_habitaciones' 0 %}">
                                <option value=""></option>
                                {% for hotel in hoteles %}
                                <option value="{{ hotel.id }}" 
                                    {% if habitaciones_existentes.0.tipo_habitacion.hotel.id == hotel.id %}selected{% endif %}>
                                    {{ hotel.nombre }} - {{ hotel.ubicacion }} ({{ hotel.estrellas }}★)
                                </option>
                                {% endfor %}
                            </select>
                            <label for="hotel">Buscar y seleccionar hotel</label>
                        </div>
                    </div>
                </div>


                <!-- Resumen y Controles -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <button type="button" id="addHabitacion" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle me-2"></i>Añadir Habitación
                        </button>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Total estimado: <span id="totalReserva">$0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 text-end">
                        <a href="{% url 'reservas:wizard_paso' tipo=tipo_reserva paso=2 %}" 
                           class="btn btn-outline-secondary btn-lg me-2">
                           <i class="bi bi-arrow-left me-2"></i>Anterior
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Continuar <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
document.addEventListener('DOMContentLoaded', function() {
    let habitacionIndex = {{ habitaciones_existentes.count|default:1 }};
    const container = document.getElementById('habitacionesContainer');
    const hotelSelect = document.getElementById('hotel');
    const totalReserva = document.getElementById('totalReserva');

    // Cargar Select2 para hoteles
    $(hotelSelect).select2({
        placeholder: "Buscar hotel...",
        allowClear: true,
        width: '100%',
        dropdownParent: $('#paso3Form')
    });

    // Actualizar números de habitación y total
    function actualizarUI() {
        document.querySelectorAll('.habitacion-numero').forEach((num, index) => {
            num.textContent = index + 1;
        });
        calcularTotal();
    }

    // Calcular total de la reserva
    function calcularTotal() {
        let total = 0;
        document.querySelectorAll('.habitacion-item').forEach(item => {
            const precio = parseFloat(item.querySelector('.precio-habitacion').textContent.replace('$', '') || 0);
            const cantidad = parseInt(item.querySelector('input[name$="_cantidad"]').value || 0);
            total += precio * cantidad;
        });
        totalReserva.textContent = `$${total.toFixed(2)}`;
    }

    // Función mejorada para clonar habitaciones
function clonarHabitacion() {
    const newItem = container.lastElementChild.cloneNode(true);
    const newIndex = habitacionIndex++;
    
    // Resetear valores
    newItem.querySelectorAll('input, select').forEach(el => {
        el.value = '';
        el.name = el.name.replace(/\d+/, newIndex);
    });
    
    // Actualizar opciones según hotel seleccionado
    const hotelId = hotelSelect.value;
    if(hotelId) {
        actualizarOpcionesHabitaciones(newItem, hotelId);
    }
    
    container.appendChild(newItem);
    actualizarUI();
}

// Función para actualizar opciones de habitaciones
function actualizarOpcionesHabitaciones(containerElement, hotelId) {
    const url = `/api/hoteles/${hotelId}/habitaciones/`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            containerElement.querySelectorAll('.tipo-habitacion').forEach(select => {
                select.innerHTML = data.map(hab => `
                    <option value="${hab.id}">
                        ${hab.nombre} (Capacidad: ${hab.capacidad})
                    </option>
                `).join('');
            });
        });
}

    // Eventos dinámicos
    container.addEventListener('change', e => {
        if (e.target.matches('.tipo-habitacion')) {
            const precio = e.target.selectedOptions[0].text.match(/\$([\d.]+)/)?.[1] || '0';
            e.target.closest('.habitacion-item').querySelector('.precio-habitacion').textContent = `$${precio}`;
            calcularTotal();
        }
        if (e.target.matches('input[name$="_cantidad"]')) {
            calcularTotal();
        }
    });

    document.getElementById('addHabitacion').addEventListener('click', clonarHabitacion);
    document.querySelectorAll('.remove-habitacion').forEach(btn => {
        btn.addEventListener('click', () => btn.closest('.habitacion-item').remove());
    });

    actualizarUI();
});
{% endblock %}